# 企业微信小程序开发的方案

1. 微信小程序迁移方案(低)
2. 企业微信直接挂载小程序 (中)
3. 成为企业微信的第三方服务商 (高)

---

前言：
企业微信小程序和微信小程序公用一个平台进行发布，所以在编译时打出不同版本的小程序包的方案 **不可行**

由于企业微信的限制，它在个人信息部分只提供了用户的 userid，姓名和性别，所以按照原先拿手机号登录的方式 **不可行**

而且企业微信有专门的登录 api 和单独的 jscode2session 机制，原先小程序的方案部分代码可以复用，但是 openid 机制会完全失效

---

## 步骤一

微信小程序迁移方案

用户先使用微信小程序，后通过技术手段和企业微信关联，并完成数据迁移

用户直接使用微信小程序几乎 0 成本，在企业微信迁移时，在我们获取全员的 userid 后，对系统内此公司数据进行迁移，即股加加系统内的 profile 要和企业微信的公司 crop id 和 人员里的 userid 进行一一绑定。

此迁移方案需要对方授权 密钥 或对方开发人员写接口来返回 access_token 用来获取上述的数据

优势：

1. 开发时间：低

缺点:

1. 后续开发无可避免
2. 数据迁移麻烦
3. 需要对方相关人员 **重度** 参与

---

## 步骤二

对方企业微信管理员做小程序关联，把我们的小程序加载进去，我们小程序成为一个他们的内部小程序

此方案需要我们开发一下几点：

1. 微信小程序兼容企业微信的登录授权机制改造
2. 系统维护一个私有化部署的公司配置的表
   例如(企业微信公司 id，公司名，公司系统对应的 url，等配置信息)，用来在小程序刚开始加载时做系统和数据方面的归属
3. 小程序开发部分新页面，用来配合企业微信的登录（企业微信小程序没有授权机制，我们只需要一个页面，默认一直在 loading，load 好进系统就行）
4. 如对方直接提供对方企业微信的 cropid 和 screct，我们还需要开发企业微信的授权机制，如对方不提供，对方需要自己开发，并和我们对接 授权登录的机制
5. 系统需要兼容用企业微信公司 id 加 userid，加授权 token 的登录机制

优势：

1. 可作为一种通用的私有化小程序方案

缺点:

1. 开发无可避免,比较麻烦
2. 需要对方相关人员 **重度** 参与

---

## 步骤三

成为企业微信第三方服务商

这个方案是开发量最多，最麻烦的，
除了步骤二的那些都要开发完成之外，
我们还需要处理应用市场里的各种回调，
比如安装完成回调，数据回调，指令回调等等

在安装完成之后，会获得一个授权码，保存后，用这个授权码和对应公司的 id 等等来直接获取 access_token，这样对方需要参与的部分就会变得非常少。

优势：

1. 完全作为一种通用方案，上架到企业微信第三方应用市场，后续做私有化部署成本低(只需要让对方企业微信管理员，添加这个 app 后，把我们部署好的系统的 url 配置给我们就行，当然普通企业默认安装，数据直接进入我们线上系统，也可以使用)
2. 需要对方相关人员 **轻度** 参与

缺点:

1. 开发非常麻烦，所有的回调交给自己处理，部分回调数据丢失基本完蛋
